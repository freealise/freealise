<!DOCTYPE html>
<html>
  <head>
    <!-- Example code adapted from goo.gl/uEx309 -->
    <title>PanoMarker</title>
    <meta charset="utf-8">
    <style>
        #map, #trackpad {
          user-select: none;
          touch-action: none;
        }
        .active {
          opacity: 1.0;
        }
        .inactive {
          opacity: 0.5;
        }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
    <script src="./panomarker.js"></script>
    <script>

var AVAILABLE_PANORAMAS = {
  grid: {
    location: {
      pano: 'grid',
      description: 'A simple test grid',
      latLng: new google.maps.LatLng(50.5818747, 5.9815603)
    },
    links: [],
    copyright: 'Imagery (c) Martin Matysiak',
    tiles: {
      tileSize: new google.maps.Size(2000, 1000),
      worldSize: new google.maps.Size(2000, 1000),
      centerHeading: 0,
      getTileUrl: function() { return 'grid.png' }
    }
  },
  /*gileppe: {
    location: {
      pano: 'gileppe',
      description: 'Lac de la Gileppe',
      latLng: new google.maps.LatLng(50.5818747, 5.9815603)
    },
    links: [],
    copyright: 'Imagery (c) Martin Matysiak',
    tiles: {
      tileSize: new google.maps.Size(4000, 2000),
      worldSize: new google.maps.Size(4000, 2000),
      centerHeading: 0,
      getTileUrl: function() { return 'gileppe.jpg' }
    }
  }*/
};

function init() {
  var container = document.getElementById('map');
  var trackpad = document.getElementById('trackpad');
  var data = document.getElementById('data');

  var panorama = new google.maps.StreetViewPanorama(
    container,
    {
      pano: 'grid',
      pov: {heading: 47.11, pitch: -13.1},
      panoProvider: function(pano) { return AVAILABLE_PANORAMAS[pano]; }
    });

  var marker = new PanoMarker(
    {
      pano: panorama,
      container: container,
      position: {heading: 89.63, pitch: -27.22},
      anchor: new google.maps.Point(20,20),
      size: new google.maps.Size(40,40),
      icon: 'info.png',
      title: 'Click me!'
    });

  var sound = { heading: 0.0, pitch: 0.0, volume: 0.0, changing: false };
  google.maps.event.addListener(marker, 'click', function() {
    if (sound.changing === false) {
      marker.setClassName('active');
      const mpos = marker.getPosition();
      panorama.addListener("pov_changed", () => {
        panorama.setPov({ heading: mpos.heading, pitch: mpos.pitch });
      });
      map.onpointermove = function(e) {
        const rect = e.target.getBoundingClientRect();
        sound.heading = e.clientX-rect.x-180;
        sound.pitch = 90-(e.clientY-rect.y);
        data.innerText = JSON.stringify(sound);
      }
      sound.changing = true;
    } else {
      panorama.removeListener("pov_changed");
      marker.setClassName('inactive');
      map.onpointermove = null;
      sound.changing = false;
      data.innerText = JSON.stringify(sound);
    }
  });
  
  trackpad.onpointermove = function(e) {
    try {
    const rect = e.target.getBoundingClientRect();
    marker.setPosition({
      heading: e.clientX-rect.x-180, 
      pitch: 90-(e.clientY-rect.y)
    });
    } catch(e) {alert(e);}
  }
  trackpad.onpointerdown = trackpad.onpointermove;
}

    </script>
  </head>
    <body onload="init()">
        <div id="map" style="width:620px; height:500px"></div>
        <div id="trackpad" style="background:url('./grid.png'); background-size: cover; width:360px; height:180px"></div>
        <div id="data"></div>
    </body>
</html>