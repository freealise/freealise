<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Web Audio API examples: MediaStreamAudioSourceNode</title>
  </head>

  <body>
    <h1>Web Audio API examples: MediaStreamAudioSourceNode</h1>
    <audio controls></audio>
    <br />
    <label for="gain">Volume: </label>
    <input id="gain" type="range" min="0" max="40" />

    <p>Biquad filter frequency response for:</p>
    <ul class="freq-response"></ul>
    <script>
      // Store useful UI elements
      const audio = document.querySelector("audio");
      const range = document.querySelector("#gain");
      const freqResponseOutput = document.querySelector(".freq-response");

      // Create float32 arrays for getFrequencyResponse()
      const frequencyArray = new Float32Array([1000, 2000, 3000, 4000, 5000]);
      const magResponseOutput = new Float32Array(frequencyArray.length);
      const phaseResponseOutput = new Float32Array(frequencyArray.length);

      navigator.mediaDevices
        .getUserMedia({ audio: true, video: false })
        .then((stream) => {
          audio.srcObject = stream;
          audio.onloadedmetadata = (e) => {
            audio.play();
            audio.muted = true;
          };

          // Create a MediaStreamAudioSourceNode
          // Feed the HTMLMediaElement into it
          const audioCtx = new AudioContext();
          const source = new MediaStreamAudioSourceNode(audioCtx, {
            mediaStream: stream,
          });

          /* Create a biquadfilter
          const biquadFilter = new BiquadFilterNode(audioCtx, {
            type: "lowshelf",
            frequency: 1000,
            gain: range.value,
          });*/

          // Create a compressor node
          const compressor = new DynamicsCompressorNode(audioCtx, {
            threshold: -100,
            knee: 40,
            ratio: 20,
            attack: 0,
            release: 0,
          });

          // Chain the nodes so we can play the
          // music and adjust the volume using the mouse cursor
          source.connect(compressor);
          compressor.connect(audioCtx.destination);

          // Get new mouse pointer coordinates when mouse is moved
          // then set new gain value
          range.oninput = () => {
            compressor.knee.value = range.value;
          };

        })
        .catch((err) => {
          console.error(`The following error occurred: ${err}`);
        });
    </script>
  </body>
</html>